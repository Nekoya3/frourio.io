---
id: additional-request
title: Additional request
---

If you add properties to the req object by Hooks, you can use AdditionalRequest to extend the type of the controller.

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs
  defaultValue="fastify"
  values={[
    { label: 'fastify', value: 'fastify' },
    { label: 'express', value: 'express' },
  ]
}>
<TabItem value="fastify">

[fastify-auth](https://github.com/fastify/fastify-auth)

```sh
cd server
npm install fastify-auth
```

```ts title="server/index.ts"
import Fastify from 'fastify'
import fastifyAuth from 'fastify-auth'
import server from './$server' // '$server.ts' is automatically generated by frourio

const fastify = Fastify()

fastify.register(fastifyAuth).after(() => {
  server(fastify, { basePath: '/api/v1' })
})
fastify.listen(3000)
```

```ts title="server/api/user/hooks.ts"
import { defineHooks } from './$relay' // '$relay.ts' is automatically generated by frourio
import { getUserIdByToken } from '$/service/user'

export type AdditionalRequest = {
  user: {
    id: string
  }
}

export default defineHooks((fastify) => ({
  preHandler: fastify.auth([
    (req, _, done) => {
      const user =
        typeof req.headers.token === 'string' &&
        getUserIdByToken(req.headers.token)

      if (user) {
        // eslint-disable-next-line
        // @ts-expect-error
        req.user = user
        done()
      } else {
        done(new Error('Unauthorized'))
      }
    }
  ])
}))
```

```ts title="server/api/user/controller.ts"
import { defineController } from './$relay'
import { getUserNameById } from '$/service/user'

export default defineController(() => ({
  // user was added by AdditionalRequest of ./hooks.ts
  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) })
}))
```

</TabItem>
<TabItem value="express">

[passport-trusted-header](http://www.passportjs.org/packages/passport-trusted-header/)

```sh
cd server
npm install passport passport-trusted-header
npm install @types/passport --save-dev
```

```ts title="server/api/user/hooks.ts"
import passport from 'passport'
import { defineHooks } from './$relay' // '$relay.ts' is automatically generated by frourio
import { getUserIdByToken } from '$/service/user'

export type AdditionalRequest = {
  user: {
    id: string
  }
}

passport.use(
  // eslint-disable-next-line
  new (require('passport-trusted-header').Strategy)(
    { headers: ['token'] },
    // eslint-disable-next-line
    (headers: { token: string }, done: Function) => {
      done(null, getUserIdByToken(headers.token))
    }
  )
)

export default defineHooks(() => ({
  onRequest: [
    passport.initialize(),
    passport.authenticate('trusted-header', { session: false })
  ]
}))
```

```ts title="server/api/user/controller.ts"
import { defineController } from './$relay'
import { getUserNameById } from '$/service/user'

export default defineController(() => ({
  // user was added by AdditionalRequest of ./hooks.ts
  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) })
}))
```

</TabItem>
</Tabs>
